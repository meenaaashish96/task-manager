name: CI/CD – Deploy Laravel to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, bcmath, curl, openssl, pdo_mysql, sqlite, intl
          coverage: none

      - name: Install Composer dependencies
        run: |
          composer install \
            --no-interaction \
            --prefer-dist

      - name: Copy .env.example to .env (for tests only)
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

      - name: Generate app key
        run: php artisan key:generate

      - name: Run tests
        run: php artisan test

  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build-and-test

    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy over SSH to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ secrets.AWS_EC2_PORT || 22 }}
          script: |
            set -e

            # Go to your project directory on the EC2 instance
            cd ${{ secrets.AWS_PROJECT_PATH }}

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Load PHP version if using something like phpenv or a specific path (optional)
            # source /etc/profile.d/php.sh

            # Install dependencies
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

            # Build frontend (optional – comment out if using pre-built assets)
            npm install --production=false
            npm run build

            # Run database migrations
            php artisan migrate --force

            # Optimize Laravel caches
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Restart queue worker / supervisor if used (example)
            # sudo systemctl restart supervisor

            echo "Deployment finished."


# Notes:
# - Configure the following GitHub repository secrets:
#   - AWS_EC2_HOST: Public IP or hostname of the EC2 instance
#   - AWS_EC2_USER: SSH username (e.g. ubuntu, ec2-user)
#   - AWS_EC2_SSH_KEY: Private SSH key contents (multi-line)
#   - AWS_EC2_PORT: SSH port (default 22, optional)
#   - AWS_PROJECT_PATH: Path on the EC2 instance, e.g. /var/www/task-manager
# - Ensure the EC2 instance already has PHP, Composer, Node, NPM, and Git installed.


